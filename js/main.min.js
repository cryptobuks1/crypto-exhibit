/*!
 * Crypto Exhibit v1.0.0-alpha (http://www.crypto-exhib.it)
 * Copyright 2019 Mannheim University of Applied Sciences, Kristian Kraljic
 * Licensed under GPL-3.0-or-later
 */
var shared=require("./shared"),algorithms=shared.algorithms,util=exports.util=require("./util"),convert=util.convert,worker=new Worker("js/worker.min.js");function elementId(e,t){if("string"!=typeof e){var r=jQuery.reduce(Array.sliceArguments(arguments,2),function(e,t){return t?e+"-"+t:e},t);return e?"$2\\[$1\\]".format(e,r):r}return elementId.apply(this,Array.spliceArguments(arguments,0,0,!1))}function elementsSelector(e,t){if("string"!=typeof e){var r=['[id|="$1"]'.format(t)];return e&&r.push('[id$="[$1]"]'.format(e)),jQuery.each(Array.sliceArguments(arguments,2),function(e,t){t&&r.push(/^:/.test(t)?t:'[id*="-$1"]'.format(t))}),r.join(String())}return elementsSelector.apply(this,Array.spliceArguments(arguments,0,0,!1))}function matchElementId(e){return/(.+)\[(\d+)\]/.exec(e)}function matchParameterId(e){return/(parameter|group)-(.+)-(.+)\[(\d+)\]/.exec(e)}function parameterValue(t,e,r){var n=function(e){return"TEXTAREA"==e.prop("tagName")?editorValue(t,matchElementId(e.attr("id"))[1],"text"):"checkbox"==e.attr("type")?e.is(":checked"):e.val()};if(arguments.length<3){var a={};return jQuery.parameter(t,e).each(function(){a[matchParameterId(jQuery(this).prop("id"))[3]]=n(jQuery(this))}),a}return n(jQuery.parameter(t,e,r))}Array.sliceArguments=function(e){return Array.prototype.slice.apply(e,Array.prototype.slice.call(arguments,1))},Array.spliceArguments=function(e){var t=jQuery.makeArray(e);return Array.prototype.splice.apply(t,Array.sliceArguments(arguments,1)),t},Array.concatArguments=function(e){return Array.prototype.concat.apply(jQuery.makeArray(e),Array.sliceArguments(arguments,1))},String.prototype.toCamelCase=function(){return this.replace(/(?:^\w|[A-Z]|\b\w)/g,function(e,t){return 0==t?e.toLowerCase():e.toUpperCase()}).replace(/\s+/g,String())},String.prototype.toCapitalizedCase=function(){return this.replace(/(?:^\w|\b\w)/g,function(e,t){return e.toUpperCase()})},String.prototype.format=function(){var r=arguments;return this.replace(/\$(\d+)/g,function(e,t){return void 0!==r[t-1]?r[t-1]:e})},jQuery.reduce=function(e,r,n){return n=void 0===n?0:n,jQuery.each(e,function(e,t){n=r.call(this,n,t,e)}),n},jQuery.fn.reduce=function(e,t){return jQuery.reduce(this,e,t)},jQuery.fn.reveal=function(e){return this.fadeIn(e?null:0)},jQuery.fn.conceal=function(e){return this.fadeOut(e?"fast":0,function(){jQuery(this).attr("style","display:none!important")})},jQuery.fn.revealOrConceal=function(e,t){e?this.reveal(t):this.conceal(t)},jQuery.element=function(e,t){return jQuery("#"+elementId.apply(this,arguments))},jQuery.elements=function(e,t){return jQuery(elementsSelector.apply(this,arguments))},jQuery.parameter=function(e,t,r,n){return"boolean"==typeof t&&(r=t,t=null),"boolean"==typeof r&&(n=r,r=null),r?jQuery.element(e,!0!==n?"parameter":"group",t,r):jQuery.elements(e,n?"group":"parameter",t,!0!==n?":input":null)},function(e){"use strict";e(document).ready(function(){toggleStep(1,1,!1),toggleStep(2,1,!1),toggleCompare(!1,!1),toggleHelp(1,null,!1),jQuery.element(1,"loading").hide(),jQuery.element(2,"loading").hide(),jQuery("textarea[data-mode]").each(function(){var e=jQuery(this),t=matchElementId(e.attr("id"));changeMode(parseInt(t[2]),t[1],e.data("mode"))}),jQuery(".container>.row").hide().removeClass("d-none").reveal(!0)}),e('[data-toggle="popover"]').popover()}(jQuery);var steps=function(e){return{algorithm:e=1,input:++e,parameters:++e,apply:++e,output:++e}}();function getAlgorithm(e){return jQuery.element(e,"algorithm").val()}function applyAlgorithm(a){var o=jQuery.element(a,"apply").prop("disabled",!0),l=jQuery.element(a,"loading"),i=getAlgorithm(a),u=getAction(a),p=algorithms[i];setTimeout(function(){l&&l.reveal(!0)},500);var s="dec"!=getMode(a,"input")?"decrypt"!=u?"hex":"text":"dec",e=editorValue(a,"input",p.inputs[u]||"text"),t=parameterValue(a,i);changeMode(a,"output",s,!0),worker.addEventListener("message",function e(t){if(t.data.algorithm==i&&t.data.action==u&&t.data.tab==a){worker.removeEventListener("message",e);var r=convert(t.data.result).from(p.outputs[u]||"text").to(s),n=32768<r.length;jQuery.element(a,"output").toggle(!n).val(!!n||r),jQuery.element(a,"performance").text(Math.round(10*t.data.time)/10),jQuery.element(a,"mode","output").toggle(!n),stepInput(a,steps.apply),n&&util.downloadBlob(new Blob([r],{type:"text"==s?"text/plain":"application/octet-stream"}),getAction(a)+"."+("text"==s?"txt":"bin")),o.prop("disabled",!1),l.conceal(!0),l=null}},!1),worker.postMessage({algorithm:i,action:u,tab:a,input:e,parameters:t})}function getAction(e){return jQuery.element(e,"actions").find("input:checked").val()}function changeAction(e,t){arguments.length<2&&(t=getAction(e)),jQuery.element(e,"actions").find("input").prop("checked",!1).filter('[value="'+t+'"]').prop("checked",!0),jQuery.element(e,"apply").find("span").text(t.toCapitalizedCase())}function getActions(e){var t=jQuery.element(e,"algorithm").find("option:selected");return(t.data("actions")||t.parent().data("actions")||"encrypt,decrypt").split(",")}function toggleActions(n,e){arguments.length<2&&(e=isComparing());var t=getActions(n),r=1==t.length;jQuery.element(n,"step",steps.input).children(".lead").text(r?"Enter anything to "+t[0]:"Choose to "+t.join(" / ")),jQuery.element(n,"actions").removeClass("invisible d-none").toggleClass(e&&r&&1<!getActions(otherTab(n)).length?"invisible":"d-none",r);var a=jQuery.element(n,"actions").find(".custom-radio").remove().filter(":nth(0)");jQuery.each(t,function(e,t){var r=t.toLowerCase()+"["+n+"]";a.clone().appendTo(jQuery.element(n,"actions")).find("input").prop("id",r).val(t).end().find("label").prop("for",r).text(t.toCapitalizedCase())}),changeAction(n,t[0])}function getMode(e,t){return jQuery("input[name=$1]:checked".format(elementId(e,"mode",t))).val()}function changeMode(e,t,r,n){arguments.length<3&&(r=getMode(e,t));var a=jQuery.element(e,t),o=a.next("div"),l=o.find('input[type="radio"][id*="-$1"]'.format(r)),i=jQuery.element(e,"file",t),u=o.data("mode")||"text";l.prop("checked",!0),o.data("mode",r),a.toggleClass("text-monospace","hex"==r),a.prop("disabled","file"==r),"file"!=r?(a.val(n||"file"==u?null:convert(a.val()).from(u).to(r)),a.data("file-value",null),i.val(null)):(a.val("No file chosen..."),i.trigger("click"))}function fileChosen(e,t){var r=jQuery.element(e,t),n=jQuery.element(e,"file",t),a=n.prop("files")[0];r.val("Chosen file: "+a.name);var o=new FileReader;o.onload=function(){n.prop("files")[0]==a&&(r.data("file-value",o.result),stepInput(e,steps.input))},o.readAsBinaryString(a)}function convertEditor(e,t){var r=jQuery.element(e,t);r.val(convert(r.val()).to(getMode(e,t)))}function editorValue(e,t,r){var n=jQuery.element(e,t),a=getMode(e,t);return convert("file"!=a?n.val():n.data("file-value")).from("file"!=a?a:"text").to(r||"text")}function otherTab(e){return e%2+1}function isComparing(){return!!jQuery.elements(2,"step",steps.algorithm,":visible").length}function toggleCompare(e,t,r){arguments.length<2&&(t=e,e=!isComparing()),r&&jQuery.each(["algorithm","input"],function(e,t){jQuery.element(2,t).val(jQuery.element(1,t).val())}),jQuery("#compare i").removeClass("fa-plus-circle fa-minus-circle").addClass("fa-$1-circle".format(e?"minus":"plus")),jQuery("#compare a").text(e?"Hide the comparison tab.":"Add another tab to compare."),jQuery.element(2,"step",steps.algorithm).revealOrConceal(e,t),e?stepInput(2,steps.algorithm):(toggleStep(2,steps.algorithm,!1,t),toggleActions(1,!1))}function toggleStep(e,t,r,n){r&&"string"!=typeof r?(jQuery.element(e,"step",t+1).stop().reveal(n),jQuery.element(e,"dummy",t+1).conceal(),jQuery.element("help",t+1).reveal(n),stepInput(e,t+1)):(jQuery.elements(e,"step",":"+(r||"gt")+"("+(t-1)+")").conceal(n).promise().done(function(){jQuery.elements(e,"dummy",":"+(r||"gt")+"("+(t-1)+")").reveal()}),jQuery.elements("help",":"+(r||"gt")+"("+Math.max(t-1,jQuery.elements(otherTab(e),"step",":visible").length-1)+")").conceal(n))}function toggleParameters(n,e,t){var r;(r=jQuery.parameter(n,e,!0)).length?(t=jQuery.parameter(n).filter(":visible").length&&t,jQuery.parameter(n,!0).conceal(t).promise().done(function(){r.each(function(){var e,t=jQuery(this).find("[data-value]:input");if(!t.val()&&(e=t.data("value"))){var r=function(e){t.val()||(t.val(e),stepInput(n,steps.input))};/\(.*\)$/i.test(e)&&jQuery.isFunction((e=util.limitedScopeEval(e,{tab:n})||String()).promise)?e.then(r):r(e)}}).reveal(t)})):toggleStep(n,steps.parameters,"eq",t)}function toggleHelp(e,t,r){var n={reveal:'[data-help="all"], [data-help="'+t+'"]',conceal:'[data-help][data-help!="all"][data-help!="'+t+'"]'};jQuery.when.apply(this,[jQuery(n.conceal).conceal(r).promise()].concat(jQuery.elements("help").map(function(){return jQuery(this).children(n.reveal).filter(":gt(2)").stop().conceal(r).promise()}))).done(function(){jQuery.elements("help").each(function(){var e=jQuery(this);e.children(n.reveal).filter(":lt(3)").reveal(r),e.children("button").revealOrConceal(!!e.children(n.reveal).filter(":gt(2)").length,r)})})}function showMore(e){jQuery.element("help",e).children("button").conceal(!0).end().children('[data-help="all"], [data-help="'+getAlgorithm()+'"]').reveal(!0)}function stepInput(e,t){var r=!1,n=getAlgorithm(e);switch(t){case steps.algorithm:((r=!!n)?shared.requireAlgorithm(n):Promise.resolve()).then(function(){toggleActions(e),toggleActions(otherTab(e)),toggleParameters(e,n,!0),toggleHelp(e,n,!0),jQuery.element(e,"output").val(null)},function(e){alert("Failed!!"+e)});break;case steps.input:if((r=!!jQuery.element(e,"input").val())&&!jQuery.parameter(e,n,!0).length)return void stepInput(e,t+1);break;case steps.parameters:r=jQuery.parameter(e,n).reduce(function(e){return e&&!!jQuery(this).val()},!0);break;case steps.apply:r=!!jQuery.element(e,"output").val();break;case steps.output:r=!0}toggleStep(e,t,r,!0)}exports.steps=steps,exports.algorithms=algorithms,exports.stepInput=stepInput,exports.changeAction=changeAction,exports.applyAlgorithm=applyAlgorithm,exports.changeMode=changeMode,exports.fileChosen=fileChosen,exports.convertEditor=convertEditor,exports.toggleCompare=toggleCompare,exports.showMore=showMore,exports.parameterValue=parameterValue;